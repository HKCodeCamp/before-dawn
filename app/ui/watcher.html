<!DOCTYPE html>
<html>
  <head>
    <link href="photon.min.css" rel="stylesheet" type="text/css" />
    <script>
     // parse incoming URL params -- we'll get a link to the current screen images for previews here
     window.urlParams = window.location.search.split(/[?&]/).slice(1).map(function(paramPair) {
       return paramPair.split(/=(.+)?/).slice(0, 2);
     }).reduce(function (obj, pairArray) {            
       obj[pairArray[0]] = pairArray[1];
       return obj;
     }, {});
    </script>
  </head>

  <body>
    <div class="window">
      <div id="wrapper"></div>
    </div>
    <script>
     var remote = window.require('electron').remote;
     var savers = remote.getGlobal('savers');
     var _ = require('lodash');

     var fs = require('fs');
     var path = require('path');
     const url = require('url');

     // the main app will pass us a screenshot URL, here it is
     var screenshot = decodeURIComponent(urlParams.screenshot);
     var src = decodeURIComponent(urlParams.src);

     // load screensaver object
     var s = savers.getByKey(src);
    
     var reloadPreview = function() {
       var iframe = document.querySelector("iframe");
       var main = document.querySelector(".window");
       iframe.width = main.offsetWidth;
       iframe.height = main.offsetHeight;

       var url_opts = {
         width: iframe.width,
         height: iframe.height,
         screenshot: screenshot
       };

       var mergedOpts = _.merge(url_opts, s.settings);
       var previewUrl = s.getUrl(mergedOpts);

       iframe.src = previewUrl;
     }

     var holder = document.getElementById("wrapper");
     var iframe = document.createElement('iframe');

     holder.appendChild(iframe);

     reloadPreview();
     window.addEventListener('resize', reloadPreview, true);

     var filePath = path.dirname(url.parse(src).path);
     fs.watch(filePath, (eventType, filename) => {
       if (filename) {
         reloadPreview();
       }
     });
    
    </script>
  </body>
</html>
